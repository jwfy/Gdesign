{% extends 'base.html' %}
{% block css %}<link href="/static/css/webuploader.css" rel="stylesheet" type="text/css"/>{% end %}
{% block active3 %}active{% end %}
{% block title %}电影列表{% end block %}
{% block content-head %}电影列表{% end block %}
{% block content %}
{% set ans = pyobject.get('result') %}
{% set query = ans.get('query') %}
{% set q = ans.get('q', '') %}
{% set r_category = ans.get('category', '') %}
{% set r_director = ans.get('directors', '') %}
{% set cast = ans.get('casts', '') %}
{% set url = '/movie/movie/list?' %}
<div class="row">
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header">
                <h3 class="box-title">电影列表{% if q %}-搜索-{{ q }}{% end %}</h3>
            </div>
            <div class="box-body">
                <div class="row" style="margin-bottom: 10px">
                    <div class="col-xs-6">
                        <button class="btn btn-default btn-sm checkbox-toggle" title="全选/全不选"><i class="fa fa-square-o"></i></button>
                        <div class="btn-group">
                            <button class="btn btn-default btn-sm iremove" title="下线"><i class="fa fa-remove"></i></button>
                            <button class="btn btn-default btn-sm inormal" title="上线"><i class="fa fa-bars"></i></button>
                        </div>
                    </div>
                    <form class="col-xs-3" style="float: right" role="search" method="post" action="/movie/movie/list">
                        <div class="has-feedback">
                            <input type="text" class="form-control input-sm" name="Q" placeholder="查找电影"/>
                            <input type="hidden" name="csrf_code" value="1234"/>
                            <span class="fa fa-search form-control-feedback"></span>
                        </div>
                    </form>
                </div>
                <table class="table table-hover removie-table">
                    <thead>
                    {% include movie/head.html %}
                    </thead>
                    <tbody>
                    {% if type(query) == list %}
                    {% for qe in query %}
                        {% include movie/body.html %}
                    {% end %}
                    {% end %}
                    </tbody>
                </table>
                {% set url = '/movie/movie/list?' %}
                {% if r_director %}
                    {% set url = url + 'directors=%s' %(r_director) %}
                {% end %}
                {% if cast %}
                    {% set url = url + '&casts=%s' %(cast) %}
                {% end %}
                {% if r_category %}
                    {% set url = url + '&category=%s' %(r_category) %}
                {% end %}
                {% if q %}
                {% set url = url + '&q=%s' %(q) %}
                {% end %}
                {% set url = url + "&page_num=%s" %}
                {% include page.html %}
            </div>
        </div>
    </div>
</div>
{% include movie/add.html %}
{% end %}

{% block js %}
        <script type="text/javascript" src="/static/js/webuploader.js"></script>
<script>
    $(function () {
        $(".inormal").click(function(){
            var ids = icheck_function($(".removie-table"));
            var status = 1;
            ajax_status(ids, status);
        });
        $(".iremove").click(function(){
            var ids = icheck_function($(".removie-table"));
            var status = 2;
            ajax_status(ids, status);
        });

        function ajax_status(ids, status){
            $.ajax({
                url:"/movie/movie/re_update_status",
                data:{"ids":JSON.stringify(ids), "status":status},
                dataType: "json" ,
                success: function(data){
                    console.log(data);
                    if(data["status"] == "success"){
                        window.location.href="/movie/movie/list";
                    }
                    else
                        alert(data["query"]);
                },
                error:function(data, status, e){
                    alert(e);
                }
            });
            return false;
        }

        $(".img-add").click(function(){
            $.ajax({
                url:"/movie/movie/re_add",
                data:{"title":$("input[name='title']").val(),
                    "_id":$("input[name='_id']").val(),
                    "img_url":$("input[name='image']").val()},
                dataType: "json" ,
                success: function(data){
                    console.log(data);
                    //debugger;
                    if(data["status"] == "success"){
                        $("#movie-add").modal('hide')
                        alert(data["query"]);
                    }
                    else
                        alert(data["query"]);
                },
                error:function(data, status, e){
                    alert(e);
                }
            });
            return false;
        });

        $("tr[data-target='#movie-add']").click(function(){
            var title = $(this).find("input[name='title']").val();
            var _id = $(this).find("input[name='_id']").val();
            $("#movie-add").find("input[name='title']").val(title);
            $("#movie-add").find("input[name='_id']").val(_id);
            webuload();
        });

        var webuload = function(){
            var $ = jQuery,
                $list = $('#fileList'),
                ratio =  1,
                thumbnailWidth = 100 * ratio,
                thumbnailHeight = 100 * ratio,
                uploader,num=0;

            uploader = WebUploader.create({
                auto: true,
                server: '/image/image/file',
                pick: '#filePicker',
                accept: {
                    title: 'Images',
                    extensions: 'gif,jpg,jpeg,bmp,png',
                    mimeTypes: 'image/*'
                }
            });

            uploader.on( 'fileQueued', function( file ) {
                if(num >=1){
                    $list.html("");
                }
                var $li = $(
                        '<div id="' + file.id + '" class="file-item thumbnail">' +
                        '<img>' +
                        '<div class="info">' + file.name + '</div>' +
                        '</div>'
                      ),
                $img = $li.find('img');
                $list.append( $li );
                num += 1;
                // 创建缩略图
                uploader.makeThumb( file, function( error, src ) {
                    if ( error ) {
                        $img.replaceWith('<span>不能预览</span>');
                        return;
                    }
                    $img.attr( 'src', src );
                }, thumbnailWidth, thumbnailHeight );
            });

            uploader.on( 'uploadSuccess', function( file , response) {
                var url = response["url"];
                $("input[name='image']").val(url);
                $( '#'+file.id ).addClass('upload-state-done');
            });

            uploader.on( 'uploadError', function( file ) {
                var $li = $( '#'+file.id ),
                        $error = $li.find('div.error');

                if ( !$error.length ) {
                    $error = $('<div class="error"></div>').appendTo( $li );
                }
                $error.text('上传失败');
            });
        };

    });

</script>
{% end %}